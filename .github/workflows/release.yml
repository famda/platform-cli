name: Release

# This workflow is triggered on pushes to main branch
# It uses Conventional Commits to determine the next version automatically
# and creates a GitHub Release with per-OS downloadable ZIP artifacts
on:
  push:
    branches: [main]

# Prevent concurrent releases
concurrency:
  group: release
  cancel-in-progress: false

jobs:
  # First job: Determine version and create release
  release:
    name: Create Release
    runs-on: ubuntu-latest
    
    # Only run if the commit is not from the release bot itself
    if: "!contains(github.event.head_commit.message, 'chore(release)')"
    
    outputs:
      released: ${{ steps.release.outputs.released }}
      version: ${{ steps.release.outputs.version }}
      tag: ${{ steps.release.outputs.tag }}
    
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      
      # Use Python Semantic Release to handle versioning based on Conventional Commits
      # This tool:
      # - Analyzes commits since the last tag
      # - Determines the next version using semantic versioning:
      #   * feat: -> MINOR version bump
      #   * fix:/perf: -> PATCH version bump  
      #   * feat!/BREAKING CHANGE: -> MAJOR version bump
      # - Updates version in pyproject.toml
      # - Creates a git tag
      # - Generates release notes from commit messages
      - name: Python Semantic Release
        id: release
        uses: python-semantic-release/python-semantic-release@v9.12.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          root_options: "-vv"

  # Second job: Build per-OS artifacts and attach to release
  build-artifacts:
    name: Build ${{ matrix.os }} artifact
    runs-on: ${{ matrix.os }}
    needs: release
    
    # Only run if a release was created
    if: needs.release.outputs.released == 'true'
    
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            artifact_name: semantics-${{ needs.release.outputs.version }}-linux-x86_64.zip
            platform: linux
          - os: windows-latest
            artifact_name: semantics-${{ needs.release.outputs.version }}-windows-x86_64.zip
            platform: windows
          - os: macos-latest
            artifact_name: semantics-${{ needs.release.outputs.version }}-macos-x86_64.zip
            platform: macos
    
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.release.outputs.tag }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
      
      # Create a self-contained bundle with venv and launcher script
      # This approach works across all platforms without requiring compilation
      - name: Build self-contained bundle (Unix)
        if: runner.os != 'Windows'
        run: |
          # Create a clean build directory
          mkdir -p dist/semantics
          
          # Install the package and its dependencies in a virtual environment
          uv venv dist/semantics/venv
          source dist/semantics/venv/bin/activate
          uv pip install .
          deactivate
          
          # Create a launcher script
          cat > dist/semantics/semantics << 'EOF'
          #!/bin/bash
          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          "$SCRIPT_DIR/venv/bin/python" -m semantics.cli "$@"
          EOF
          chmod +x dist/semantics/semantics
          
          # Create a README for the bundle
          cat > dist/semantics/README.txt << 'EOF'
          Semantics CLI - ${{ needs.release.outputs.version }}
          
          This is a self-contained distribution of the semantics CLI tool.
          
          Usage:
            ./semantics --help
            ./semantics -i input.mp4 -o output/ --transcribe
          
          The bundle includes:
          - semantics CLI tool
          - Python virtual environment with all dependencies
          - Launch script
          
          Requirements:
          - Python 3.12+ must be installed on your system
          
          For more information, visit:
          https://github.com/famda/platform-cli
          EOF
          
          # Create the ZIP archive
          cd dist
          zip -r ../semantics-${{ needs.release.outputs.version }}-${{ matrix.platform }}-x86_64.zip semantics/
      
      - name: Build self-contained bundle (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # Create a clean build directory
          New-Item -ItemType Directory -Force -Path dist\semantics
          
          # Install the package and its dependencies in a virtual environment
          uv venv dist\semantics\venv
          dist\semantics\venv\Scripts\Activate.ps1
          uv pip install .
          deactivate
          
          # Create a launcher batch script
          @'
          @echo off
          set SCRIPT_DIR=%~dp0
          "%SCRIPT_DIR%venv\Scripts\python.exe" -m semantics.cli %*
          '@ | Out-File -FilePath dist\semantics\semantics.bat -Encoding ASCII
          
          # Create a README for the bundle
          @'
          Semantics CLI - ${{ needs.release.outputs.version }}
          
          This is a self-contained distribution of the semantics CLI tool.
          
          Usage:
            semantics.bat --help
            semantics.bat -i input.mp4 -o output\ --transcribe
          
          The bundle includes:
          - semantics CLI tool
          - Python virtual environment with all dependencies
          - Launch script (semantics.bat)
          
          Requirements:
          - Python 3.12+ must be installed on your system
          
          For more information, visit:
          https://github.com/famda/platform-cli
          '@ | Out-File -FilePath dist\semantics\README.txt -Encoding UTF8
          
          # Create the ZIP archive
          Compress-Archive -Path dist\semantics\* -DestinationPath semantics-${{ needs.release.outputs.version }}-${{ matrix.platform }}-x86_64.zip
      
      # Upload the artifact to the GitHub Release
      - name: Upload artifact to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release.outputs.tag }}
          files: semantics-${{ needs.release.outputs.version }}-${{ matrix.platform }}-x86_64.zip
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
