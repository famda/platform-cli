# Dev build workflow - creates prerelease on every push to main
# This workflow creates a rolling "dev" prerelease that always has the latest builds

name: Dev Build

on:
  push:
    branches: [main]
    paths-ignore:
      - "docs/**"
      - "*.md"
      - ".gitignore"

permissions:
  contents: write
  actions: read

concurrency:
  group: dev-build
  cancel-in-progress: true

jobs:
  # Run tests first
  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install dependencies
        run: uv sync --frozen --extra dev

      - name: Run tests
        run: uv run pytest tests/ -v --ignore=tests/build

  # Calculate version
  version:
    name: Calculate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      short_sha: ${{ steps.version.outputs.short_sha }}

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate version
        id: version
        run: |
          # Count commits for version number
          COMMIT_COUNT=$(git rev-list --count HEAD)
          SHORT_SHA=$(git rev-parse --short HEAD)
          VERSION="0.1.${COMMIT_COUNT}-dev"
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "Calculated version: $VERSION (sha: $SHORT_SHA)"

  # Build all variants using reusable workflow
  build:
    name: Build
    needs: [test, version]
    uses: ./.github/workflows/build.yml
    with:
      version: ${{ needs.version.outputs.version }}
      git_sha: ${{ github.sha }}
      artifact_suffix: dev

  # Create/update dev prerelease
  release:
    name: Create Dev Release
    runs-on: ubuntu-latest
    needs: [version, build]

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: "*-dev-*"

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          
          # Move and rename all artifacts
          for dir in artifacts/*/; do
            for zip in "$dir"*.zip; do
              if [ -f "$zip" ]; then
                # Extract artifact name from directory
                artifact_name=$(basename "$dir")
                # Remove the -dev suffix for cleaner release names
                clean_name=$(echo "$artifact_name" | sed 's/-dev-/-/')
                cp "$zip" "release-assets/${clean_name}.zip"
                echo "Prepared: ${clean_name}.zip"
              fi
            done
          done
          
          ls -la release-assets/

      - name: Delete existing dev release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Delete existing dev release if it exists
          gh release delete dev --yes || true
          # Also delete the tag
          git push origin :refs/tags/dev || true

      - name: Create dev release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create dev \
            --title "Development Build" \
            --notes "**⚠️ Development Build - Use at your own risk**

          This is an automated development build from the latest \`main\` branch.

          **Version:** \`${{ needs.version.outputs.version }}\`
          **Commit:** [\`${{ needs.version.outputs.short_sha }}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})

          ## Installation

          ### Windows (PowerShell)
          \`\`\`powershell
          irm https://raw.githubusercontent.com/${{ github.repository }}/main/docs/install.ps1 | iex
          # Or with prerelease flag:
          iex \"& { \$(irm https://raw.githubusercontent.com/${{ github.repository }}/main/docs/install.ps1) } -Prerelease\"
          \`\`\`

          ### Linux/macOS (Bash)
          \`\`\`bash
          curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/docs/install.sh | bash
          # Or with prerelease flag:
          curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/docs/install.sh | bash -s -- --prerelease
          \`\`\`

          ## Variants

          | Variant | Description |
          |---------|-------------|
          | \`semantics\` | Full version with all modules |
          | \`semantics-audio\` | Audio processing only |
          | \`semantics-video\` | Video processing only |
          | \`semantics-document\` | Document processing only |

          ---
          *This release is automatically updated on every push to main.*" \
            --prerelease \
            release-assets/*.zip
